<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="app.patient.mapper.PatientMapper">

  <select id="search" resultType="app.patient.entity.PatientEntity">
    SELECT
      patient_id,
      patient_no,
      name,
      gender,
      birth_date,
      phone,
      email,
      address,
      address_detail,
      guardian_name,
      guardian_phone,
      guardian_relation,
      is_foreigner,
      contact_priority,
      note,
      status_code,
      is_vip,
      photo_url,
      created_at,
      updated_at
    FROM patient
    WHERE status_code != 'INACTIVE'
    <choose>
      <when test="type == 'patientId'">
        AND TO_CHAR(patient_id) LIKE '%' || #{keyword} || '%'
      </when>
      <when test="type == 'patientNo'">
        AND patient_no LIKE '%' || #{keyword} || '%'
      </when>
      <when test="type == 'name'">
        AND name LIKE '%' || #{keyword} || '%'
      </when>
      <when test="type == 'phone'">
        AND phone LIKE '%' || #{keyword} || '%'
      </when>
      <when test="type == 'birthDate'">
        AND birth_date = #{keyword}
      </when>
      <otherwise>
        AND name LIKE '%' || #{keyword} || '%'
      </otherwise>
    </choose>
    ORDER BY created_at DESC
  </select>
  <select id="searchMulti" resultType="app.patient.entity.PatientEntity">
    SELECT
      patient_id,
      patient_no,
      name,
      gender,
      birth_date,
      phone,
      email,
      address,
      address_detail,
      guardian_name,
      guardian_phone,
      guardian_relation,
      is_foreigner,
      contact_priority,
      note,
      status_code,
      is_vip,
      photo_url,
      created_at,
      updated_at
    FROM patient
    <where>
      status_code != 'INACTIVE'
      <if test="name != null and name != ''">
        AND name LIKE '%' || #{name} || '%'
      </if>
      <if test="phone != null and phone != ''">
        AND phone LIKE '%' || #{phone} || '%'
      </if>
      <if test="birthDate != null and birthDate != ''">
        AND TO_CHAR(birth_date, 'YYYY-MM-DD') = #{birthDate}
      </if>
    </where>
    ORDER BY created_at DESC
  </select>
</mapper>
